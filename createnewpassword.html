<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set New Password</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Set New Password</h2>

    <div id="message-box" class="mt-6 p-4 rounded-lg text-sm">Verifying...</div>

    <form id="reset-form" class="space-y-4 hidden">
      <div class="relative">
        <input type="password" id="new-password" placeholder="New password" required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-700" />
        <button type="button" onclick="togglePassword('new-password')" class="absolute inset-y-0 right-3 flex items-center text-gray-500">üëÅ</button>
      </div>

      <div class="relative">
        <input type="password" id="confirm-password" placeholder="Confirm password" required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-700" />
        <button type="button" onclick="togglePassword('confirm-password')" class="absolute inset-y-0 right-3 flex items-center text-gray-500">üëÅ</button>
      </div>

      <button type="submit" id="resetButton"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
        Reset Password
      </button>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      const SUPABASE_URL = 'https://qxluetvkqxillhqsbubl.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4bHVldHZrcXhpbGxocXNidWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM5MzIwNTMsImV4cCI6MjA0OTUwODA1M30.11cD0yE0aJW1OIx0kB4EaWtCvg5nUkj-0QuTVk-C7zg';
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const messageBox = document.getElementById('message-box');
      const resetForm = document.getElementById('reset-form');
      const newPasswordInput = document.getElementById('new-password');
      const confirmPasswordInput = document.getElementById('confirm-password');
      const resetButton = document.getElementById('resetButton');

      let access_token = null;
      let refresh_token = null;

      function showMessage(text, type = 'info') {
        messageBox.textContent = text;
        messageBox.className = 'mt-6 p-4 rounded-lg text-sm';
        if (type === 'success') messageBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-400');
        else if (type === 'error') messageBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
        else messageBox.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-400');
      }

      function togglePassword(id) {
        const field = document.getElementById(id);
        field.type = field.type === "password" ? "text" : "password";
      }

      async function handleReset() {
        showMessage('Verifying reset link...', 'info');
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        access_token = params.get('access_token');
        refresh_token = params.get('refresh_token');

        if (!access_token || !refresh_token) {
          showMessage('‚ùå Missing access or refresh token in URL. Please use the link from your email.', 'error');
          return;
        }

        const { error } = await client.auth.setSession({ access_token, refresh_token });
        if (error) {
          console.error('Session error:', error);
          showMessage('‚ùå Reset link invalid or expired. Please request a new one.', 'error');
          return;
        }

        showMessage('‚úÖ Verified. Enter your new password:', 'success');
        resetForm.classList.remove('hidden');
      }

      resetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (newPassword !== confirmPassword) {
          showMessage('‚ùå Passwords do not match.', 'error');
          return;
        }

        resetButton.disabled = true;
        resetButton.textContent = 'Resetting...';
        showMessage('Updating password...', 'info');

        try {
          const res = await fetch(`${SUPABASE_URL}/functions/v1/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              access_token: access_token,
              new_password: newPassword
            })
          });

          const result = await res.json();
          if (result.status === "success") {
            showMessage('‚úÖ Password changed successfully! You can now log in.', 'success');
          } else {
            showMessage('‚ùå ' + result.message, 'error');
          }
        } catch (err) {
          showMessage('‚ùå Network error.', 'error');
          console.error(err);
        }

        resetButton.disabled = false;
        resetButton.textContent = 'Reset Password';
      });

      handleReset();
    </script>
  </div>
</body>
</html>
