<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Send Password Reset Link</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Send Password Reset Link</h2>
    <form id="email-form" class="space-y-4">
      <input
        type="email"
        id="email"
        placeholder="Enter your email"
        required
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-700"
      />
      <button
        type="submit"
        id="sendButton"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
      >
        Send Reset Link
      </button>
    </form>

    <div id="message-box" class="mt-6 p-4 rounded-lg text-sm hidden"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = 'https://qxluetvkqxillhqsbubl.supabase.co';

      // ⚠️ TEST ONLY: Using service_role key here (never expose in production)
      const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4bHVldHZrcXhpbGxocXNidWJsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczMzkzMjA1MywiZXhwIjoyMDQ5NTA4MDUzfQ.iN5FcDv76gXu5Mbi7iUvRq-0ALBSvPlLc20mVBDvxPw';
      const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4bHVldHZrcXhpbGxocXNidWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM5MzIwNTMsImV4cCI6MjA0OTUwODA1M30.11cD0yE0aJW1OIx0kB4EaWtCvg5nUkj-0QuTVk-C7zg';

      // Client for DB queries (safe)
      const client = supabase.createClient(SUPABASE_URL, ANON_KEY);

      // Admin client (used for checking/creating auth users)
      const adminClient = supabase.createClient(SUPABASE_URL, SERVICE_ROLE_KEY);

      const emailForm = document.getElementById('email-form');
      const emailInput = document.getElementById('email');
      const sendButton = document.getElementById('sendButton');
      const messageBox = document.getElementById('message-box');

      function showMessage(text, type = 'info') {
        messageBox.textContent = text;
        messageBox.className = 'mt-6 p-4 rounded-lg text-sm';
        if (type === 'success') {
          messageBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-400');
        } else if (type === 'error') {
          messageBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
        } else {
          messageBox.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-400');
        }
        messageBox.classList.remove('hidden');
      }

      emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim().toLowerCase();

        sendButton.disabled = true;
        sendButton.textContent = 'Processing...';
        showMessage('Checking account details...', 'info');

        // 1. Check if email exists in one of your DB tables
        let userFoundInDatabase = false;
        const tableConfigs = [
          { name: 'students', emailColumn: 'email' },
          { name: 'teachers', emailColumn: 'teacheremail' },
          { name: 'parents', emailColumn: 'parentemail' }
        ];

        for (const config of tableConfigs) {
          const { data, error } = await client
            .from(config.name)
            .select(config.emailColumn)
            .eq(config.emailColumn, email)
            .maybeSingle();

          if (data) {
            userFoundInDatabase = true;
            console.log(`Email found in ${config.name} table.`);
            break;
          }
          if (error) console.error(`Error checking ${config.name}:`, error.message);
        }

        if (!userFoundInDatabase) {
          showMessage('Account not found. Please ensure you have registered with this email.', 'error');
          sendButton.disabled = false;
          sendButton.textContent = 'Send Reset Link';
          return;
        }

        showMessage('Verifying Supabase Auth account...', 'info');

        // 2. Check if user exists in Supabase Auth (via listUsers)
        const { data: userList, error: adminError } = await adminClient.auth.admin.listUsers();

        if (adminError) {
          console.error("Admin API error:", adminError.message);
          showMessage('An error occurred during account verification.', 'error');
          sendButton.disabled = false;
          sendButton.textContent = 'Send Reset Link';
          return;
        }

        const existingUser = userList.users.find(u => u.email?.toLowerCase() === email);

        if (!existingUser) {
          // No Auth account → create one
          showMessage('Creating Supabase Auth account...', 'info');
          const randomPassword = Math.random().toString(36).slice(2, 15) + Math.random().toString(36).slice(2, 15);

          const { data: signUpData, error: signUpError } = await adminClient.auth.admin.createUser({
            email: email,
            password: randomPassword,
            email_confirm: true
          });

          if (signUpError) {
            showMessage('❌ Error creating account: ' + signUpError.message, 'error');
            console.error('Sign up error:', signUpError);
          } else {
            showMessage('Account created. Sending password reset link...', 'info');
            await client.auth.resetPasswordForEmail(email, {
              redirectTo: 'https://changepassword-kappa.vercel.app/createnewpassword.html'
            });
            showMessage('✅ Account created and reset link sent to ' + email, 'success');
          }

        } else {
          // User exists → send reset link
          showMessage('Sending password reset link...', 'info');
          const { error: resetError } = await client.auth.resetPasswordForEmail(email, {
            redirectTo: 'https://changepassword-kappa.vercel.app/createnewpassword.html'
          });
          if (resetError) {
            showMessage('❌ Error sending reset link: ' + resetError.message, 'error');
          } else {
            showMessage('✅ Reset link will be sent to ' + email + 'within 5 minutes', 'success');
          }
        }

        sendButton.disabled = false;
        sendButton.textContent = 'Send Reset Link';
      });
    </script>
  </div>
</body>
</html>

